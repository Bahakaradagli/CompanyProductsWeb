<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VELİOĞLU GLOBAL DIŞ TİCARET LİMİTED ŞİRKETİ – Markalar</title>

  <!-- fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- ortak stiller (varsa) -->
  <link rel="stylesheet" href="common.css">
  <!-- bu sayfanın stilleri -->
  <link rel="stylesheet" href="index.css">

  <!-- Basit notif bar stili -->
  <style>
    .notifbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: none;
      padding: 10px 14px;
      color: #fff;
      z-index: 9999;
      font-weight: 600;
      text-align: center;
    }
    .notifbar--info { background: #3b82f6; }   /* mavi */
    .notifbar--ok { background: #22c55e; }     /* yeşil */
    .notifbar--err { background: #ef4444; }    /* kırmızı */
    body.__pushdown { padding-top: 44px; }     /* bar açıkken içerik zıplamasın diye */
  </style>
</head>
<body>
  <!-- ==== NOTIF BAR ==== -->
  <div id="notifBar" class="notifbar notifbar--info" role="status" aria-live="polite"></div>

  <!-- ==== DESKTOP NAV ==== -->
  <header class="desknav" role="banner" style="--accent:#54577D">
    <div class="desknav__wrap">
      <div class="desknav__inner">
        <!-- Sol: Logo + Başlık -->
        <div class="desknav__brand">
          <img class="desknav__logo"
               src="assets/logo-150.png"
               alt="VELİOĞLU GLOBAL DIŞ TİCARET LİMİTED ŞİRKETİ Logo"
               onerror="this.style.display='none'">
          <span class="desknav__title">VELİOĞLU GLOBAL DIŞ TİCARET LİMİTED ŞİRKETİ DAĞITIM</span>
        </div>

        <!-- Sağ: Sekmeler + Giriş/Ürün Aksiyonları -->
        <nav class="desknav__tabs" aria-label="Ana gezinme">
          <a class="desknav__tab" href="index.html" aria-current="page">
            <span class="desknav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M10 6V5a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v1m-9 4h14m-15 0a2 2 0 0 1 2-2h11a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7Z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </span>
            <span>Markalar</span>
          </a>
          <a class="desknav__tab" href="products.html">
            <span class="desknav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4 7h7v7H4V7Zm9 0h7v7h-7V7ZM8 17h8v3H8v-3Z" fill="currentColor"/></svg>
            </span>
            <span>Ürünler</span>
          </a>
          <a class="desknav__tab" href="contact.html">
            <span class="desknav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M3 10h18M5 10v8m4-8v8m6-8v8m4-8v8M3 18h18M12 4 3 8h18L12 4Z"
              fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </span>
            <span>İletişim</span>
          </a>

          <!-- Aksiyon butonları (login sonrası görünür) -->
          <button id="addBtn" class="desknav__tab desknav__tab--action" style="display:none">
            <span>Ekle</span>
          </button>
          <button id="bulkBtn" class="desknav__tab desknav__tab--action" style="display:none">
            <span>Excel</span>
          </button>
          <button id="manageBtn" class="desknav__tab desknav__tab--action" style="display:none">
            <span>Ürünler</span>
          </button>

          <button id="loginBtn" class="desknav__tab desknav__tab--ghost">
            <span>Giriş</span>
          </button>
        </nav>
      </div>
    </div>
  </header>

  <!-- ==== SAYFA İÇERİĞİ ==== -->
  <main class="container">
    <h2 class="page-title">Markalar</h2>
    <div id="brands" class="brands" aria-live="polite"></div>
  </main>

  <footer>
    <small>© <span id="y"></span> VELİOĞLU GLOBAL DIŞ TİCARET LİMİTED ŞİRKETİ • GitHub Pages</small>
  </footer>

  <!-- ===== MODALLAR ===== -->
  <!-- Giriş Modal -->
  <dialog id="loginModal" class="modal">
    <form method="dialog" class="modal__card" id="loginForm">
      <button class="modal__x" type="button" id="loginCancel">✕</button>
      <h3 class="modal__title">Giriş Yap</h3>
      <div class="grid2">
        <div class="form__row">
          <label>Kullanıcı adı</label>
          <input type="text" name="user" placeholder="admin" required />
        </div>
        <div class="form__row">
          <label>Şifre</label>
          <input type="password" name="pass" placeholder="••••••••" required />
        </div>
      </div>
      <p class="form__hint">Demo: <code>admin</code> / <code>veliogluGlobal34</code></p>
      <p class="form__error" id="loginError" hidden>Hatalı kullanıcı adı veya şifre.</p>
      <div class="modal__actions">
        <button class="btn" value="cancel" type="button" id="loginCancel2">İptal</button>
        <button class="btn btn--primary" type="submit">Giriş</button>
      </div>
    </form>
  </dialog>

  <!-- Ürün Ekle Modal -->
  <dialog id="productModal" class="modal">
    <form method="dialog" class="modal__card" id="productForm">
      <button class="modal__x" type="button" id="productCancelX">✕</button>
      <h3 class="modal__title">Ürün Ekle</h3>

      <div class="grid2">
        <div class="form__row">
          <label>Ürün Adı</label>
          <input type="text" name="name" required />
        </div>
        <div class="form__row">
          <label>Marka</label>
          <input type="text" name="brand" placeholder="Doğuş" />
        </div>
        <div class="form__row">
          <label>Katalog (slug)</label>
          <input type="text" name="catalog" placeholder="dogus" required />
        </div>
        <div class="form__row">
          <label>Kategori</label>
          <input type="text" name="category" placeholder="Dökme Çay" />
        </div>
        <div class="form__row">
          <label>Paket</label>
          <input type="text" name="package" placeholder="500 g" />
        </div>
        <div class="form__row">
          <label>Koli Adedi</label>
          <input type="number" name="case_qty" placeholder="12" min="0" />
        </div>
        <!-- URL ALANI KALDIRILDI -->
        <!-- YENİ: Sadece dosyadan yükleme -->
        <div class="form__row grid2__span">
          <label>Görsel Yükle</label>
          <input type="file" name="imgFile" id="imgFile" accept="image/*" required />
          <small class="hint">Görsel seçmeden ürün kaydedilemez.</small>
        </div>
      </div>

      <p class="form__error" id="productError" hidden>Kaydedilemedi. Lütfen tekrar deneyin.</p>
      <p class="form__success" id="productOk" hidden>Kaydedildi!</p>

      <div class="modal__actions">
        <button class="btn" value="cancel" type="button" id="productCancel">Vazgeç</button>
        <button class="btn btn--primary" type="submit">Kaydet</button>
      </div>
    </form>
  </dialog>

  <!-- Ürünleri Yönet Modal (liste + silme) -->
  <dialog id="manageModal" class="modal">
    <div class="modal__card" id="manageCard">
      <button class="modal__x" type="button" id="manageClose">✕</button>
      <h3 class="modal__title">Ürünleri Yönet</h3>

      <div class="toolbar">
        <div class="left">
          <input id="mSearch" class="input" placeholder="Ada, markaya ya da kategoriye göre ara…" />
        </div>
        <div class="right">
          <span class="pill"><strong id="mCount">0</strong> adet ürün</span>
        </div>
      </div>

      <div class="scroll-x">
        <table class="table" id="mTable">
          <thead>
            <tr>
              <th style="min-width:120px;">ID</th>
              <th>Ad</th>
              <th>Marka</th>
              <th>Katalog</th>
              <th>Kategori</th>
              <th>Paket</th>
              <th>Koli</th>
              <th>Görsel</th>
              <th>İşlem</th>
            </tr>
          </thead>
          <tbody id="mTbody"></tbody>
        </table>
      </div>

      <p class="hint">Silme işlemleri geri alınamaz. Onay kutusu çıkacaktır.</p>
    </div>
  </dialog>

  <!-- Toplu Ekle (Excel/CSV) Modal -->
  <dialog id="bulkModal" class="modal">
    <div class="modal__card" id="bulkCard">
      <button class="modal__x" type="button" id="bulkClose">✕</button>
      <h3 class="modal__title">Toplu Ekle (Excel / CSV)</h3>

      <div class="form__row">
        <label>Dosya Yükle (<span class="mono">.xlsx, .xls, .csv</span>)</label>
        <input type="file" id="bulkFile" accept=".xlsx,.xls,.csv" />
        <div class="hint">Beklenen başlıklar: <span class="mono">name, brand, catalog, category, package, case_qty, img</span></div>
      </div>

      <div class="toolbar" style="margin-top:12px">
        <div class="left">
          <button class="btn" id="downloadTemplate">Şablon İndir (CSV)</button>
        </div>
        <div class="right">
          <span id="bulkStatus" class="muted">Dosya seçin…</span>
        </div>
      </div>

      <div id="bulkPreviewWrap" class="scroll-x" style="display:none;">
        <table class="table" id="bulkPreview">
          <thead><tr id="bulkHead"></tr></thead>
          <tbody id="bulkBody"></tbody>
        </table>
      </div>

      <div class="modal__actions">
        <button class="btn" id="bulkCancel">Vazgeç</button>
        <button class="btn btn--primary" id="bulkImport" disabled>İçe Aktar</button>
      </div>
      <p class="form__success" id="bulkOk" hidden>Toplu ekleme tamamlandı.</p>
      <p class="form__error" id="bulkErr" hidden>Toplu ekleme sırasında hata oluştu.</p>
    </div>
  </dialog>

  <!-- ===== SCRIPTS ===== -->
  <script>
    // Aktif sekme emniyet
    (function(){
      const here = (location.pathname.split('/').pop() || 'index.html');
      document.querySelectorAll('.desknav__tab[href]').forEach(t=>{
        const isHere = (t.getAttribute('href')||'') === here || (here==='' && t.getAttribute('href')==='index.html');
        t.setAttribute('aria-current', isHere ? 'page' : 'false');
      });
    })();

    // Basit notif yardımcıları
    const notifBar = document.getElementById('notifBar');
    function showNotif(msg, type='info'){
      notifBar.textContent = msg;
      notifBar.classList.remove('notifbar--info','notifbar--ok','notifbar--err');
      notifBar.classList.add(type==='ok'?'notifbar--ok':type==='err'?'notifbar--err':'notifbar--info');
      notifBar.style.display = 'block';
      document.body.classList.add('__pushdown');
    }
    function hideNotif(){
      notifBar.style.display = 'none';
      document.body.classList.remove('__pushdown');
    }
  </script>

  <!-- SheetJS (Excel/CSV okumak için) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase + RTDB + Storage Upload -->
  <script type="module">
    // ==== Firebase config ====
    const firebaseConfig = {
      apiKey: "AIzaSyAKZslnECwA0wwMAhfHarE3wMLXoq7TV1k",
      authDomain: "veliogluglobal-86631.firebaseapp.com",
      databaseURL: "https://veliogluglobal-86631-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "veliogluglobal-86631",
      storageBucket: "veliogluglobal-86631.firebasestorage.app", // ✅ DÜZELTİLDİ
      messagingSenderId: "643623290439",
      appId: "1:643623290439:web:a61c004610ceb9e1105362",
      measurementId: "G-D0WT8BV4C5"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, push, set, serverTimestamp, get, child, remove, onValue
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Başlat
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    // ✅ Bucket'ı explicit veriyoruz
    const storage = getStorage(app, "gs://veliogluglobal-86631.firebasestorage.app");

    // ==== DEMO Auth (client-side) ====
    const LOGIN_USER = "admin";
    const LOGIN_PASS = "veliogluGlobal34";
    const isAuthed   = () => localStorage.getItem("isAdmin") === "1";
    const setAuthed  = (v) => (v ? localStorage.setItem("isAdmin","1") : localStorage.removeItem("isAdmin"));

    const loginBtn   = document.getElementById("loginBtn");
    const addBtn     = document.getElementById("addBtn");
    const bulkBtn    = document.getElementById("bulkBtn");
    const manageBtn  = document.getElementById("manageBtn");
    const loginDlg   = document.getElementById("loginModal");
    const productDlg = document.getElementById("productModal");
    const manageDlg  = document.getElementById("manageModal");
    const bulkDlg    = document.getElementById("bulkModal");
    const loginForm  = document.getElementById("loginForm");
    const productForm= document.getElementById("productForm");

    function refreshAuthUI(){
      if(isAuthed()){
        addBtn.style.display = "";
        bulkBtn.style.display = "";
        manageBtn.style.display = "";
        loginBtn.querySelector("span:last-child").textContent = "Çıkış";
        loginBtn.classList.remove("desknav__tab--ghost");
        document.body.classList.add('compact-actions');
      }else{
        addBtn.style.display = "none";
        bulkBtn.style.display = "none";
        manageBtn.style.display = "none";
        loginBtn.querySelector("span:last-child").textContent = "Giriş";
        loginBtn.classList.add("desknav__tab--ghost");
        document.body.classList.remove('compact-actions');
      }
    }
    refreshAuthUI();

    // Login / Logout
    function closeLogin(){ loginDlg.close(); }
    loginBtn.addEventListener("click", ()=>{
      if(isAuthed()){ setAuthed(false); refreshAuthUI(); return; }
      loginDlg.showModal();
    });
    document.getElementById("loginCancel").addEventListener("click", closeLogin);
    document.getElementById("loginCancel2").addEventListener("click", closeLogin);
    loginForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const fd = new FormData(loginForm);
      const u = (fd.get("user")||"").trim();
      const p = (fd.get("pass")||"").trim();
      const err = document.getElementById("loginError");
      if(u === LOGIN_USER && p === LOGIN_PASS){
        setAuthed(true);
        err.hidden = true;
        closeLogin();
        refreshAuthUI();
      }else{
        err.hidden = false;
      }
    });

    // Ürün Ekle
    function closeProduct(){ productDlg.close(); }
    document.getElementById("productCancel").addEventListener("click", closeProduct);
    document.getElementById("productCancelX").addEventListener("click", closeProduct);
    addBtn.addEventListener("click", ()=> productDlg.showModal());

    productForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!isAuthed()){ alert("Önce giriş yapın."); return; }

      const fd = new FormData(productForm);
      const file = fd.get("imgFile");

      const okEl = document.getElementById("productOk");
      const errEl= document.getElementById("productError");
      okEl.hidden = true; errEl.hidden = true;

      try{
        // Görsel zorunlu
        if(!(file && file instanceof File && file.size > 0)){
          throw new Error("Lütfen bir görsel seçin.");
        }

        showNotif("Ürününüz ekleniyor…", "info");

        const raw = {
          name: (fd.get("name")||"").trim(),
          brand: (fd.get("brand")||"").trim() || null,
          catalog: (fd.get("catalog")||"").trim(),
          category: (fd.get("category")||"").trim() || null,
          package: (fd.get("package")||"").trim() || null,
          case_qty: fd.get("case_qty") ? Number(fd.get("case_qty")) : null,
          created_at: serverTimestamp()
        };

        const cat = (raw.catalog || slugify(raw.name || "urun")).toLowerCase();
        const base = slugify(`${raw.name || "urun"}`) || "urun";
        const ext0  = file.type?.split("/")[1] || "jpg";
        const ext   = ext0.toLowerCase()==="jpeg" ? "jpg" : ext0.toLowerCase();
        const key  = `products/${cat}/${base}-${Date.now()}.${ext}`;

        const storageRef = sRef(storage, key);
        await uploadBytes(storageRef, file, { contentType: file.type });
        const finalImgUrl = await getDownloadURL(storageRef);

        const product = normalizeProduct({
          ...raw,
          img: finalImgUrl
        });

        const newRef = push(ref(db, "products"));
        await set(newRef, product);

        okEl.hidden = false;
        showNotif("Ürününüz eklendi ✅", "ok");
        setTimeout(()=> hideNotif(), 1200);

        productForm.reset();
        setTimeout(()=>{ closeProduct(); okEl.hidden = true; }, 700);
      }catch(err){
        console.error(err);
        showNotif("Yüklenemedi. Lütfen tekrar deneyin.", "err");
        setTimeout(()=> hideNotif(), 3000);
        errEl.hidden = false;
      }
    });

    // ==== Markaları RTDB'den çıkar & çiz ====
    async function renderBrandsFromRTDB(){
      const wrap = document.getElementById('brands');
      wrap.innerHTML = '';

      const snap = await get(child(ref(db), "products"));
      if(!snap.exists()){
        wrap.innerHTML = '<div style="color:#A8AFBD">Henüz ürün yok.</div>';
        document.getElementById("y").textContent = new Date().getFullYear();
        return;
      }
      const data = snap.val(); // {autoId: product,...}

      // brand → {count, img(any)}
      const map = new Map();
      for (const p of Object.values(data)){
        const brand = (p.brand || '').trim();
        if(!brand) continue;
        if(!map.has(brand)) map.set(brand, {count:0, img:null});
        const rec = map.get(brand);
        rec.count++;
        if(!rec.img && p.img) rec.img = p.img;
      }

      // sıralama: alfabetik (TR duyarlı)
      const items = [...map.entries()].sort((a,b)=> a[0].localeCompare(b[0], 'tr'));

      for(const [brand, info] of items){
        const a = document.createElement('a');
        a.href = 'products.html#brand=' + encodeURIComponent(brand);
        a.className = 'brand';
        a.innerHTML = `
          <img src="${info.img || ''}" alt="${brand} logosu">
          <div class="brand__text">
            <h4>${brand}</h4>
            <small>${info.count} ürün</small>
          </div>`;
        const img = a.querySelector('img');
        img.onerror = () => {
          img.onerror = null;
          img.src = 'https://dummyimage.com/88x88/0b0d12/ffffff&text=' + encodeURIComponent((brand||'M')[0]);
        };
        wrap.appendChild(a);
      }

      document.getElementById("y").textContent = new Date().getFullYear();
    }

    // Yönetim listesi: canlı dinleme + tablo doldurma
    let _allProducts = []; // {id, ...product}
    function liveBindProducts(){
      onValue(ref(db, "products"), (snap)=>{
        const arr = [];
        if(snap.exists()){
          snap.forEach(ch=>{
            const val = ch.val();
            arr.push({ id: ch.key, ...val });
          });
        }
        _allProducts = arr;
        renderManageTable();
        renderBrandsFromRTDB(); // markaları da güncelle
      });
    }

    // Yönetim modalı
    const mTbody = document.getElementById('mTbody');
    const mCount = document.getElementById('mCount');
    const mSearch = document.getElementById('mSearch');

    function renderManageTable(){
      const q = (mSearch.value||'').toLowerCase();
      const list = _allProducts.filter(p=>{
        const hay = [p.id, p.name, p.brand, p.catalog, p.category, p.package, String(p.case_qty||'')].join(' ').toLowerCase();
        return hay.includes(q);
      });
      mCount.textContent = list.length;
      mTbody.innerHTML = '';
      for(const p of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${p.id}</td>
          <td>${escapeHtml(p.name||'-')}</td>
          <td>${escapeHtml(p.brand||'-')}</td>
          <td>${escapeHtml(p.catalog||'-')}</td>
          <td>${escapeHtml(p.category||'-')}</td>
          <td>${escapeHtml(p.package||'-')}</td>
          <td>${p.case_qty ?? '-'}</td>
          <td>${p.img ? `<a href="${p.img}" target="_blank" rel="noopener">gör</a>` : '-'}</td>
          <td>
            <div class="row-actions">
              <button class="btn" data-del="${p.id}">Sil</button>
            </div>
          </td>
        `;
        mTbody.appendChild(tr);
      }
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    mSearch.addEventListener('input', renderManageTable);

    // Silme işlevi
    mTbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-del]');
      if(!btn) return;
      const id = btn.getAttribute('data-del');
      if(!id) return;
      if(!isAuthed()){ alert('Önce giriş yapın.'); return; }
      const ok = confirm(`Bu ürünü silmek istediğinize emin misiniz?\nID: ${id}`);
      if(!ok) return;
      try{
        await remove(ref(db, `products/${id}`));
        // onValue tetikler, tablo/markalar tazelenir
      }catch(err){
        console.error(err);
        alert('Silinirken bir hata oluştu.');
      }
    });

    // Modal aç/kapat
    document.getElementById('manageBtn').addEventListener('click', ()=>{
      if(!isAuthed()){ alert('Önce giriş yapın.'); return; }
      renderManageTable();
      manageDlg.showModal();
    });
    document.getElementById('manageClose').addEventListener('click', ()=> manageDlg.close());

    // ===== Toplu Ekle (Excel/CSV) =====
    const bulkFile = document.getElementById('bulkFile');
    const bulkStatus = document.getElementById('bulkStatus');
    const bulkHead = document.getElementById('bulkHead');
    const bulkBody = document.getElementById('bulkBody');
    const bulkPreviewWrap = document.getElementById('bulkPreviewWrap');
    const bulkImportBtn = document.getElementById('bulkImport');
    const bulkErr = document.getElementById('bulkErr');
    const bulkOk = document.getElementById('bulkOk');

    let parsedRows = []; // normalize edilmiş objeler
    let originalHeaders = [];

    function resetBulkUI(){
      bulkStatus.textContent = 'Dosya seçin…';
      bulkPreviewWrap.style.display = 'none';
      bulkHead.innerHTML = '';
      bulkBody.innerHTML = '';
      bulkImportBtn.disabled = true;
      bulkErr.hidden = true;
      bulkOk.hidden = true;
      parsedRows = [];
      originalHeaders = [];
    }

    function closeBulk(){ bulkDlg.close(); resetBulkUI(); }

    document.getElementById('bulkBtn').addEventListener('click', ()=>{
      if(!isAuthed()){ alert('Önce giriş yapın.'); return; }
      resetBulkUI();
      bulkDlg.showModal();
    });
    document.getElementById('bulkClose').addEventListener('click', closeBulk);
    document.getElementById('bulkCancel').addEventListener('click', closeBulk);

    // Şablon indir (CSV)
    document.getElementById('downloadTemplate').addEventListener('click', ()=>{
      const headers = ['name','brand','catalog','category','package','case_qty','img'];
      const rows = [
        ['Doğuş Rize Turist', 'Doğuş', 'dogus', 'Dökme Çay', '500 g', '12', 'https://.../rize500.png'],
        ['Doğadan Form', 'Doğadan', 'dogadan', 'Poşet Çay', '20 li', '24', 'https://.../form20.png'],
      ];
      const csv = [headers.join(','), ...rows.map(r=>r.map(cell=>csvEscape(cell)).join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'urun_sablon.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
    function csvEscape(s){
      const str = String(s ?? '');
      if(/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
      return str;
    }

    // Dosya seçilince oku
    bulkFile.addEventListener('change', async ()=>{
      bulkErr.hidden = true; bulkOk.hidden = true;
      const f = bulkFile.files?.[0];
      if(!f){ resetBulkUI(); return; }
      try{
        if (typeof XLSX === 'undefined') {
          resetBulkUI();
          bulkErr.hidden = false;
          bulkErr.textContent = 'Excel kütüphanesi (XLSX) yüklenemedi. İnternet erişimini ve script etiketini kontrol edin.';
          return;
        }

        const data = await f.arrayBuffer();
        let rows = [];
        if(f.name.toLowerCase().endsWith('.csv')){
          const text = new TextDecoder('utf-8').decode(new Uint8Array(data));
          const wb = XLSX.read(text, {type:'string'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
        }else{
          const wb = XLSX.read(data, {type:'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
        }
        if(!rows.length){ throw new Error('Boş dosya'); }

        // Başlıklar
        originalHeaders = (rows.shift() || []).map(h => String(h||'').trim());
        const normKeys = originalHeaders.map(h => normalizeHeader(h));

        // Minimum gerekli başlıklar kontrolü
        const required = ['name','catalog'];
        const present = new Set(normKeys);
        const missing = required.filter(k => !present.has(k));
        if (missing.length){
          resetBulkUI();
          bulkErr.hidden = false;
          bulkErr.textContent = 'Eksik başlık(lar): ' + missing.join(', ') + '. İlk satırın başlık olduğundan emin olun.';
          return;
        }

        // Önizleme başlık çiz
        bulkHead.innerHTML = originalHeaders.map(h=>`<th>${escapeHtml(h||'')}</th>`).join('');

        // Satırları normalize et
        const tmp = [];
        for(const r of rows){
          const obj = {};
          for(let i=0;i<normKeys.length;i++){
            const key = normKeys[i];
            if(!key) continue;
            obj[key] = r[i] ?? null;
          }
          const normalized = normalizeProduct({
            name: obj.name ?? null,
            brand: obj.brand ?? null,
            catalog: obj.catalog ?? null,
            category: obj.category ?? null,
            package: obj.package ?? null,
            case_qty: obj.case_qty ?? null,
            img: obj.img ?? null,
            created_at: serverTimestamp()
          });
          if(normalized.name && normalized.catalog){
            tmp.push(normalized);
          }
        }
        parsedRows = tmp;

        // Önizleme (ilk 100 satır)
        const maxRows = 100;
        bulkBody.innerHTML = '';
        const previewRows = rows.slice(0, maxRows);
        for(const r of previewRows){
          const tds = originalHeaders.map((_,i)=>`<td class="hard-wrap">${escapeHtml(r[i] ?? '')}</td>`).join('');
          const tr = document.createElement('tr'); tr.innerHTML = tds; bulkBody.appendChild(tr);
        }
        bulkPreviewWrap.style.display = '';
        bulkStatus.innerHTML = `<span class="status-ok">${parsedRows.length}</span> satır hazır. <span class="muted">(Önizleme ilk ${Math.min(maxRows, rows.length)} satır)</span>`;
        bulkImportBtn.disabled = parsedRows.length===0;
      }catch(err){
        console.error(err);
        resetBulkUI();
        bulkErr.hidden = false;
        bulkErr.textContent = 'Dosya okunamadı. Başlıkları ve formatı kontrol edin.';
      }
    });

    // Toplu içe aktarma
    document.getElementById('bulkImport').addEventListener('click', async ()=>{
      if(!isAuthed()){ alert('Önce giriş yapın.'); return; }
      bulkErr.hidden = true; bulkOk.hidden = true;
      if(!parsedRows.length){ alert('İçe aktarılacak satır yok.'); return; }
      const confirmTxt = `Toplam ${parsedRows.length} ürünü eklemek istiyor musunuz?`;
      if(!confirm(confirmTxt)) return;

      try{
        for(const p of parsedRows){
          const newRef = push(ref(db, "products"));
          await set(newRef, p);
        }
        bulkOk.hidden = false;
        bulkStatus.innerHTML = `<span class="status-ok">${parsedRows.length}</span> ürün eklendi.`;
        setTimeout(()=>{ closeBulk(); }, 900);
      }catch(err){
        console.error(err);
        bulkErr.hidden = false;
      }
    });

    // ==== Helpers ====
    function normalizeHeader(h){
      const s = String(h||'').toLowerCase().trim();
      if(['ürün','urun','ürün adı','urun adi','name','ad'].includes(s)) return 'name';
      if(['brand','marka'].includes(s)) return 'brand';
      if(['katalog','catalog','slug'].includes(s)) return 'catalog';
      if(['kategori','category'].includes(s)) return 'category';
      if(['paket','package','ambalaj','paket/gramaj'].includes(s)) return 'package';
      if(['koli','koli adedi','case','case_qty','koli_sayisi','case qty'].includes(s)) return 'case_qty';
      if(['img','image','görsel','gorsel','image_url','url'].includes(s)) return 'img';
      return s;
    }

    function normalizeProduct(p){
      let cq = p.case_qty;
      if(cq!==null && cq!==undefined && cq!==''){
        const n = Number(cq);
        p.case_qty = Number.isFinite(n) ? n : null;
      }else{
        p.case_qty = null;
      }
      for(const k of ['name','brand','catalog','category','package','img']){
        if(p[k]!==null && p[k]!==undefined){
          p[k] = String(p[k]).trim();
          if(p[k]==='') p[k] = null;
        }
      }
      return p;
    }

    function slugify(s){
      return String(s || "")
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-zA-Z0-9]+/g,"-")
        .replace(/^-+|-+$/g,"")
        .toLowerCase();
    }

    // Devreye al
    liveBindProducts();
    renderBrandsFromRTDB();
    document.getElementById("y").textContent = new Date().getFullYear();
  </script>
</body>
</html>
